<analysis>**original_problem_statement:**
O usuário solicitou uma nova funcionalidade e relatou diversos problemas, incluindo um erro crítico de deploy e bugs de usabilidade.

**Novas Funcionalidades:**
1.  **Criar Papel de Usuário SEMED 3:**
    *   Criar um novo papel de usuário chamado SEMED 3.
    *   Este papel deve ter acesso de **somente visualização** a várias partes do sistema: Dashboard, Escolas, Turmas, Alunos, Servidores, Componentes Curriculares, Usuários, Diário AEE, Frequência, Notas, Calendário, Avisos, Analytics e Usuários Online.
    *   Este papel **NÃO** deve ter acesso ou visibilidade das seções Log de Conversas, Ferramentas e Mantenedora, que são exclusivas do Administrador.
    *   Nenhuma funcionalidade de criação, edição ou exclusão deve estar disponível para este papel.

**Bugs Relatados na Sessão (Agora Resolvidos):**
1.  **Erro ao Salvar Escola:** A edição ou criação de escolas falhava com Erro ao salvar escola.
2.  **Atualização Automática de Página:** Várias páginas (, , , etc.) atualizavam-se sozinhas a cada ~60 segundos, interrompendo o trabalho do usuário.
3.  **Bug na Matrícula AEE:** O sistema não reconhecia turmas de AEE existentes ao tentar matricular um aluno.
4.  **Erro de Network Error:** O frontend exibia Network Error momentaneamente após a reinicialização dos containers no ambiente de produção.
5.  **Erro de Compilação (ESLint):** O ambiente de desenvolvimento local exibia erros de ESLint que quebravam a aplicação.
6.  **Inconsistência na Aplicação de Caixa Alta:** Os dados não estavam sendo salvos consistentemente em maiúsculas, exigindo o uso de uma ferramenta de migração manual.
7.  **Bug na Página de Usuários Online:** A lista inicial de usuários online não exibia o administrador conectado.

**Bugs de Sessões Anteriores (Ainda Pendentes):**
1.  **Deploy em Produção (Coolify):** Problema crônico de Bad Gateway após cada deploy, exigindo intervenção manual no servidor para reconectar os containers à rede.

**User's preferred language**: Portuguese (Português)

**what currently exists?**
A aplicação full-stack (React + FastAPI + MongoDB) está funcional. Nesta sessão, o agente focou em estabilizar a aplicação, corrigindo uma série de bugs críticos que afetavam a experiência do usuário, como o recarregamento automático de páginas e erros ao salvar dados. Foi implementada uma nova funcionalidade robusta para rastrear usuários online e a aplicação de caixa alta foi reforçada em todos os endpoints. O agente está atualmente no meio da implementação de um novo papel de usuário com permissões de somente leitura. O problema mais crítico, o processo de deploy em produção, permanece sem uma solução definitiva, embora um comando de correção manual tenha sido fornecido e refinado.

**Last working item**:
-   **Last item agent was working:** O agente estava implementando o novo papel de usuário SEMED 3. Ele já havia adicionado o papel ao modelo Pydantic no backend () e estava no processo de adicionar  às listas de permissão de todos os endpoints de leitura (GET) para garantir o acesso de visualização. O agente usou  para identificar todos os arquivos de rota que precisam de modificação.
-   **Status:** IN PROGRESS
-   **Agent Testing Done:** N
-   **Which testing method agent to use?** both
    -   **Backend Testing:** Usar o agente de testes para criar um usuário  e verificar que ele pode fazer requisições  para todos os endpoints permitidos, mas recebe erro  ao tentar , ,  ou .
    -   **Frontend Testing:** Usar o agente de testes para fazer login como  e verificar se:
        1.  Os menus Log de Conversas, Ferramentas e Mantenedora não são visíveis.
        2.  Em todas as páginas acessíveis, os botões Novo, Editar, Salvar, Excluir estão desabilitados ou ocultos.
-   **User Testing Done:** N

**All Pending/In progress Issue list**:
-   **Issue 1: (P0) Processo de Deploy em Produção Quebrado (Gateway Timeout / Bad Gateway).**
-   **Issue 2: (P1) Criação de Turmas não atualiza a lista de forma consistente.**
-   **Issue 3: (P2) Inconsistência nos dados do Dashboard Analítico.**
-   **Issue 4: (P3) Migração para CAIXA ALTA pode estar incompleta.**

**Issues Detail:**
-   **Issue 1: Processo de Deploy em Produção Quebrado (Gateway Timeout / Bad Gateway).**
    -   **Attempted fixes:** O agente forneceu um comando  manual e o refinou com base no feedback do usuário sobre os nomes dos containers. Isso funciona como uma solução temporária após cada deploy.
    -   **Next debug checklist:**
        1.  Revisar a configuração do  para entender por que o  não está sendo respeitado pelo Coolify.
        2.  Investigar os logs do Coolify e do Traefik no momento do deploy para identificar a causa raiz da desconexão da rede.
        3.  Sugerir ao usuário a possibilidade de usar Post-Deployment Commands na UI do Coolify para automatizar o comando de reconexão de rede como uma solução intermediária.
    -   **Why fix this issue and what will be achieved with the fix?** Este é o bloqueador mais crítico. Impede que o usuário utilize novas funcionalidades em produção de forma autônoma e gera frustração. A resolução trará estabilidade e confiança ao processo de deploy.
    -   **Status:** IN PROGRESS
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** backend
    -   **Blocked on other issue:** Não. É o bloqueador principal.

-   **Issue 2: Criação de Turmas não atualiza a lista de forma consistente.**
    -   **Attempted fixes:** Nenhuma nesta sessão. É um problema reportado anteriormente.
    -   **Next debug checklist:**
        1.  Adicionar logs detalhados nos endpoints  (criação) e  (listagem) no backend.
        2.  No frontend (), adicionar logs no  para garantir que ele está sendo chamado com os filtros corretos após a criação.
        3.  Pedir ao usuário para reproduzir o erro e fornecer os logs do backend e do console do navegador.
    -   **Why fix this issue and what will be achieved with the fix?** Garante feedback visual imediato e correto para o usuário, melhorando a usabilidade.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** frontend
    -   **Blocked on other issue:** Não.

-   **Issue 3: Inconsistência nos dados do Dashboard Analítico.**
    -   **Attempted fixes:** Correção na lógica do endpoint  em uma sessão anterior.
    -   **Why fix this issue and what will be achieved with the fix?** Fornece dados confiáveis para a gestão.
    -   **Status:** USER VERIFICATION PENDING
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** frontend
    -   **Blocked on other issue:** Issue 1 (Deploy Quebrado).

-   **Issue 4: Migração para CAIXA ALTA pode estar incompleta.**
    -   **Attempted fixes:** Nesta sessão, o agente aplicou a função  em todos os endpoints de criação e atualização de Alunos, Responsáveis, Usuários e AEE para garantir que os dados sejam salvos em maiúsculas.
    -   **Why fix this issue and what will be achieved with the fix?** Garante a consistência visual e dos dados em toda a aplicação, eliminando a necessidade de ferramentas de migração manual.
    -   **Status:** USER VERIFICATION PENDING
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** backend
    -   **Blocked on other issue:** Não.

**In progress Task List**:
-   **Task 1: (P0) Concluir implementação do papel de usuário SEMED 3.**
    -   **Where to resume:**
        1.  **Backend:** Continuar a percorrer a lista de arquivos de rotas (gerada via ) e adicionar  a todos os endpoints  relevantes.
        2.  **Frontend:** Após o backend, modificar o  e  para ocultar os menus e links restritos com base no .
        3.  **Frontend:** Percorrer todas as páginas de CRUD (Alunos, Escolas, Turmas, etc.) e desabilitar/ocultar botões de ação (Salvar, Novo, Editar, Excluir) para o papel .
    -   **What will be achieved with this?** A aplicação terá um novo papel de usuário com permissões de somente leitura, conforme solicitado.
    -   **Status:** IN PROGRESS
    -   **Should Test frontend/backend/both after fix?** both
    -   **Blocked on something:** Não.

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   (P1) Implementar paginação ou carregar mais na listagem de turmas para evitar problemas de performance com grande volume de dados.
-   **Future Tasks:**
    -   (P2) Refatorar o componente  para melhor manutenibilidade.
    -   (P2) Implementar envio de e-mail de confirmação na pré-matrícula.
    -   (P2) Continuar a refatoração do backend, movendo rotas do  para arquivos dedicados.

**Completed work in this session**
-   **Nova Funcionalidade: Página de Usuários Online:** Criada uma página () que mostra em tempo real os usuários com sessões ativas, usando um middleware no backend para rastreamento confiável.
-   **Correção de Bug Crítico: Atualizações Automáticas de Página:** Resolvido o problema de recarregamento automático em várias páginas (, , , etc.) ao estabilizar as dependências nos hooks do React (, ) com  e .
-   **Correção de Bug Crítico: Erro ao Salvar Escola:** Resolvido o erro que impedia a criação e edição de escolas, tratando strings vazias no backend antes da validação Pydantic.
-   **Aplicação Universal de CAIXA ALTA:** A função de conversão para maiúsculas () foi aplicada em todos os endpoints de criação e atualização de dados (Alunos, Usuários, Responsáveis, AEE), garantindo que os dados sejam salvos corretamente.
-   **Resolução de Conflito de Dependências (ESLint):** Corrigido um erro de compilação do frontend causado por um conflito de versões do ESLint, fazendo o downgrade do pacote no .
-   **Melhoria de UX (Cadastro de Alunos):** O formulário de matrícula em programas foi aprimorado com um fluxo em cascata (Escola -> Tipo de Atendimento -> Turma) e a listagem de alunos agora exige a seleção de uma escola.
-   **Correção de Bug (Turma AEE):** Ajustado o filtro no frontend para ser case-insensitive, resolvendo um bug onde turmas de AEE não eram encontradas.

**Code Architecture**


**Key Technical Concepts**
-   **React Hook Stabilization:** Uso de  e  para evitar re-renders e chamadas de API desnecessárias causadas por dependências instáveis em  e  (como objetos  ou o  de autenticação).
-   **FastAPI Middleware:** Implementação de um middleware para interceptar requisições autenticadas e rastrear a última atividade do usuário, criando um sistema de sessão ativa mais robusto que WebSockets.
-   **Backend Data Sanitization:** Resolução de um bug de validação Pydantic ao criar uma função no endpoint que recebe o payload como um , limpa strings vazias ( -> ), e só então instancia o modelo Pydantic para validação e uso.
-   **Dependency Conflict Resolution:** Diagnóstico e resolução de um erro de compilação no frontend investigando o  e o  para identificar um conflito de versão entre  e , resolvido com o downgrade de um pacote.

**All files of reference**
-    (Onde o papel  foi adicionado)
-    (Todos os arquivos de rotas serão modificados para adicionar o papel  aos endpoints GET)
-    (Será modificado para ocultar menus para o papel )
-    (Várias páginas serão modificadas para desabilitar controles de edição)

**Critical Info for New Agent**
-   **Prioridade 1 é o Deploy:** O problema do deploy em produção via Coolify é o maior ponto de dor do usuário. Embora haja um comando manual, uma solução permanente é crucial. Investigue a configuração do  e os logs do Coolify.
-   **Prioridade 2 é o Papel :** Esta é a tarefa em andamento. Termine de adicionar as permissões no backend e depois implemente as restrições de UI no frontend. O trabalho é repetitivo mas precisa ser completo.
-   **Padrões de Correção Importantes:**
    -   **Auto-Refresh:** Se um bug de recarregamento de página aparecer, verifique as dependências de / (especialmente , , ). A solução é estabilizá-las com  ou .
    -   **Erros ao Salvar:** Se ocorrer um erro de validação (422), a causa provável são strings vazias enviadas pelo formulário. A solução é limpar o payload no backend *antes* da validação Pydantic.

**Last 10 User Messages and any pending HUMAN messages**
1.  **Usuário (Feature Request):** Solicitou a criação do papel SEMED 3 com acesso de somente visualização a páginas específicas. (Status: **IN PROGRESS**)
2.  **Usuário (Clarification):** Confirmou a lista de páginas e o comportamento de somente visualização para o novo papel. (Status: **IN PROGRESS**)
3.  **Usuário (Bug Report):** Reportou Bad Gateway no ambiente de produção. (Status: **WORKAROUND PROVIDED**)
4.  **Usuário (Request):** Pediu um comando rápido para corrigir o Bad Gateway. (Status: **PROVIDED**)
5.  **Usuário (Feedback):** Informou que o comando falhou porque os nomes dos containers estavam incorretos. (Status: **ADDRESSED**)
6.  **Usuário (Information):** Forneceu a lista de nomes de containers corretos. (Status: **ADDRESSED**)
7.  **Agente (Action):** Forneceu o comando corrigido para reiniciar e reconectar os containers. (Status: **DONE**)
8.  **Usuário (Bug Report):** Mostrou um screenshot de Network Error após executar o comando. (Status: **ADDRESSED**)
9.  **Usuário (Information):** Forneceu os logs do backend que mostravam que o serviço estava online e respondendo. (Status: **ADDRESSED**)
10. **Agente (Instruction):** Confirmou que o backend estava OK e instruiu o usuário a recarregar a página (F5), explicando que o erro era temporário. (Status: **DONE**)

**Project Health Check:**
-   **Broken:**
    -   O processo de deploy para produção via Coolify está fundamentalmente quebrado, exigindo intervenção manual a cada deploy. Isso impede a entrega contínua e autônoma de valor.

**3rd Party Integrations**
-   Nenhuma nova integração foi adicionada.

**Testing status**
-   **Testing agent used after significant changes:** NO (Não para a tarefa atual, mas foi usado em tarefas anteriores na sessão).
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:** []
-   **Known regressions:** Nenhuma nova regressão conhecida. O deploy quebrado é um problema crônico.

**Credentials to test flow:**
-   **Administrador:**  / 
-   **Para testar o novo papel, será necessário criar um usuário  após a implementação ser concluída.**

**What agent forgot to execute**
-   O agente ainda não começou a parte de frontend da implementação do papel SEMED 3. O foco até agora foi no backend.
-   O agente não abordou as outras issues pendentes do handoff anterior ( e ), focando corretamente na resolução de bugs mais críticos e na nova feature solicitada pelo usuário.</analysis>
