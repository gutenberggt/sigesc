<analysis>**original_problem_statement:**
O usuário iniciou a sessão para resolver um problema de deploy no ambiente de produção (Coolify), onde as alterações não estavam sendo refletidas. A sessão evoluiu para uma série de solicitações de funcionalidades e correções de bugs, incluindo:
-   Ajustes na interface do usuário (remover e-mail do dashboard, substituir ).
-   Implementação de um toggle para exibir/ocultar o botão de Pré-Matrícula na tela de login.
-   Adição de campos de contato para o Responsável Legal da mantenedora.
-   Correção de um bug de 404 ao clicar em notificações de mensagens.
-   Refatoração das permissões de usuário para o perfil Secretário, restringindo o acesso a exclusões e criações.
-   Correção de um crash no frontend (Objects are not valid as a React child) através da implementação de um tratador de erros global para erros de validação da API.
-   Implementação de um sistema de sessão persistente, aumentando a duração do token JWT e adicionando um mecanismo de auto-refresh.
-   Expansão da funcionalidade offline para permitir o cadastro e edição de alunos.
-   Adição de legendas explicativas nos PDFs de boletins e fichas individuais para certos níveis de ensino.
-   Implementação de um sistema completo de registro de atestados médicos, que bloqueia o lançamento de frequência pelo professor.
-   Diagnóstico e fornecimento de uma solução para o problema central de deploy/cache, que envolve o CDN do usuário (StackPath/Convesio) e o processo de build do Docker.

**User's preferred language**: Portuguese (Português)

**what currently exists?**
A aplicação full-stack (React + FastAPI + MongoDB) está funcional no ambiente de preview da Emergent, com várias novas funcionalidades e correções de bugs implementadas. O principal problema é que o ambiente de produção do usuário ( + ) está servindo uma versão antiga do frontend devido a um problema agressivo de cache. O agente implementou múltiplas soluções no código (cache-busting no Dockerfile, headers de cache no Nginx, meta tags no HTML e um arquivo  para verificação) e está aguardando o usuário realizar ações em sua infraestrutura externa (limpar o cache do CDN e forçar um novo build) para validar a correção.

**Last working item**:
-   **Last item agent was working:** Finalizando o diagnóstico do problema de deploy e cache em produção. O agente propôs uma solução focada em corrigir a configuração de cache (no , , ) e aguardou a confirmação do usuário para seguir com essa abordagem em vez de uma alternativa mais complexa (Nginx duplo). O usuário concordou com a abordagem recomendada.
-   **Status:** USER VERIFICATION PENDING
-   **Agent Testing Done:** Y (As alterações no código foram validadas e o build do frontend foi bem-sucedido.)
-   **Which testing method agent to use?** N/A. A resolução depende de ações do usuário em sua infraestrutura externa (Coolify e StackPath CDN). O próximo agente deve aguardar o feedback do usuário.
-   **User Testing Done:** N

**All Pending/In progress Issue list**:
-   **Issue 1: (P0) Deploy em Produção (Coolify) não reflete as atualizações**
    -   **Description:** O ambiente de produção do usuário, servido através do Coolify e um CDN (StackPath), está exibindo uma versão desatualizada do frontend. Os logs de acesso mostram que um arquivo JS antigo () está sendo servido, indicando um problema de cache no CDN ou no processo de build do Docker.
    -   **Attempted fixes:**
        -   Adicionado o arquivo  para permitir a verificação da versão do build implantado.
        -   Adicionado um argumento  ao  do frontend para invalidar o cache do Docker durante o build.
        -   Modificado o  para adicionar headers de  específicos, instruindo a não cachear ,  e .
        -   Adicionado meta tags  e  no  como uma camada extra de proteção.
    -   **Next debug checklist:**
        1.  Aguardar a confirmação do usuário de que ele realizou a ação de **Purge Cache** no painel de controle de seu CDN (StackPath/Convesio).
        2.  Aguardar a confirmação de que o usuário realizou um novo deploy no Coolify, utilizando uma opção de **Force rebuild** ou **Build without cache**.
        3.  Pedir ao usuário para acessar a URL de produção  e verificar se o conteúdo corresponde à versão mais recente.
        4.  Se o problema persistir, o foco deve ser guiar o usuário na configuração de regras de cache diretamente em sua plataforma de CDN.
    -   **Why fix this issue and what will be achieved with the fix?** Este é um bloqueador crítico. Nenhuma das novas funcionalidades e correções de bugs está disponível para os usuários finais. A resolução permitirá que a versão de produção seja sincronizada com a de desenvolvimento.
    -   **Status:** USER VERIFICATION PENDING
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** Frontend
    -   **Blocked on other issue:** Não.

**In progress Task List**:
Nenhuma.

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   **(P1) Melhoria Pré-Matrícula:** Enviar um email de confirmação para o responsável após a pré-matrícula ser enviada com sucesso.
    -   **(P1) Melhoria na Lista de Alunos:** Implementar a lógica na página  para usar o parâmetro de URL  e destacar o aluno recém-criado na lista.
-   **Future Tasks:**
    -   **(P2) Refatoração do Backend:** Continuar movendo endpoints do  para routers modulares.
    -   **(P2) Refatoração do Frontend:** Simplificar o componente , que se tornou muito complexo.
    -   **(P2) Expansão Offline:** Estender a funcionalidade offline para o módulo de matrículas.
    -   **(P2) Padronização de Erros:** Aplicar o novo utilitário  em todos os componentes restantes que fazem chamadas de API.
    -   **(P3) Limpeza de Código:** Remover o arquivo obsoleto .
    -   **(P3) Relatórios:** Criar relatórios gerenciais para atestados médicos (ex: por período, por escola).

**Completed work in this session**
-   **Deploy/Cache:** Diagnosticado o problema de cache em produção e implementado múltiplas correções (cache-busting no Docker, headers de cache no Nginx, meta tags no HTML, ).
-   **Atestados Médicos:** Implementada funcionalidade completa para registro de atestados médicos, incluindo backend (modelo, router, endpoints) e frontend (UI na página de alunos, modal de registro e bloqueio na tela de frequência).
-   **Funcionalidade Offline (Alunos):** Expandido o suporte offline para permitir a criação e edição de alunos, com sincronização em segundo plano.
-   **Sessão Persistente:** Aumentado o tempo de expiração do token JWT e implementado um mecanismo de auto-refresh para evitar logouts automáticos.
-   **Tratamento de Erros:** Criado um utilitário global () e refatorado os principais componentes para tratar erros de validação da API de forma padronizada, corrigindo um crash de UI.
-   **Permissões de Usuário:** Refinadas as permissões para o perfil 'Secretário', restringindo o acesso a ações de exclusão e criação em vários módulos.
-   **Correções de UI e Bugs:** Removido o e-mail do dashboard, corrigido um erro 404 em notificações de mensagens, e atualizado o  principal.
-   **Novos Campos:** Adicionados campos de Celular e E-mail para o Responsável Legal.
-   **PDFs:** Adicionada uma legenda dinâmica nos PDFs (Boletim e Ficha Individual) para notas conceituais.

**Earlier issues found/mentioned but not fixed**
-   Nenhum.

**Known issue recurrence from previous fork**
-   O problema de falha de build do frontend evoluiu para o atual problema de cache/deploy em produção, que é a questão principal desta sessão.

**Code Architecture**


**Key Technical Concepts**
-   **CDN Cache Debugging:** Diagnóstico de problemas de cache em produção (StackPath/Convesio), uso de , e configuração de .
-   **Docker Build Cache:** Uso de  como cache buster para forçar a reconstrução de camadas da imagem Docker.
-   **Nginx Configuration:** Configuração de  por tipo de arquivo () para otimizar a entrega de conteúdo estático.
-   **Offline First (Dexie.js):** Expansão da arquitetura offline para suportar operações de CRUD (Create/Update) em um novo módulo (Alunos) usando  e um service worker com background sync.
-   **Error Handling (Frontend):** Criação de um utilitário global para parsear e exibir mensagens de erro de validação (Pydantic) de forma consistente na UI.
-   **JWT Authentication:** Implementação de um interceptor de API () para refresh automático de tokens de acesso expirados, garantindo uma sessão de usuário persistente.

**key DB schema**
-   **medical_certificates:**  (nova coleção)
-   **students:** A tabela agora pode ser manipulada offline via .

**changes in tech stack**
-   Frontend: Adicionada a dependência  para gerar IDs únicos para registros offline.

**All files of reference**
-    (adicionado )
-    (adicionados )
-    (adicionadas  tags de cache)
-    (novo arquivo para verificação de versão)
-    (novo utilitário de erro)
-    (implementação de atestados e offline)
-    (lógica para bloquear frequência com atestado)
-    (novo serviço para alunos offline)
-    (adicionado modelo )
-    (novo router para atestados)
-    (registro do novo router e índice)
-    (aumento do tempo de expiração do token)
-    (adicionado interceptor de refresh de token)

**Areas that need refactoring**:
-   : Continua muito grande e necessita de mais modularização.
-   : Componente extremamente grande e complexo, candidato ideal para ser dividido em subcomponentes menores.
-   **Error Handling:** A nova função  em  deve ser aplicada em todos os  blocks restantes da aplicação para consistência.

**key api endpoints**
-    (POST, GET, DELETE): Novos endpoints para gerenciar atestados médicos.
-   : Endpoint atualizado para processar criações e atualizações de alunos da fila de sincronização offline.

**Critical Info for New Agent**
-   **A PRIORIDADE MÁXIMA É RESOLVER O PROBLEMA DE DEPLOY/CACHE.** Não inicie nenhuma nova funcionalidade até que o usuário confirme que as últimas alterações estão visíveis em seu ambiente de produção. Sua primeira ação deve ser perguntar ao usuário sobre o status do Purge Cache no CDN (StackPath) e do novo deploy no Coolify.
-   O arquivo  foi criado por engano e precisa ser removido, pois não é relevante para a infraestrutura do usuário (Coolify).
-   A solução para o problema de deploy não está apenas no código, mas na infraestrutura externa do usuário (Coolify, StackPath). Esteja preparado para guiar o usuário sobre onde encontrar as configurações relevantes nessas plataformas.

**documents and test reports created in this job**
-   

**Last 10 User Messages and any pending HUMAN messages**
10.  - Usuário escolhe a opção 1, concordando com a abordagem do agente de manter a arquitetura atual e focar na limpeza de cache do CDN.
9.  Usuário pergunta se a proposta de adicionar um segundo Nginx para desabilitar o cache é viável.
8.  Usuário envia logs de deploy do Coolify/produção.
7.  Usuário confirma que usa o CDN Convesio / StackPath.
6.   - Usuário reporta o problema central de deploy/cache.
5.   - Usuário solicita sugestões de novas funcionalidades.
4.  Usuário solicita a implementação do sistema de atestados médicos.
3.  Usuário solicita a adição de legendas aos PDFs.
2.   - Usuário solicita a funcionalidade de alunos offline.
1.   - Usuário aprova a tarefa de tornar a expiração do token configurável.

**Project Health Check:**
-   **Broken:** O pipeline de deploy para o ambiente de produção está funcionalmente quebrado. Embora os builds passem, o conteúdo servido ao usuário final está desatualizado devido a um cache agressivo no CDN e/ou no processo de build do Docker.

**3rd Party Integrations**
-   reportlab
-   PyPDF2
-   openpyxl
-   slowapi
-   dexie & dexie-react-hooks
-   uuid (novo)

**Testing status**
-   **Testing agent used after significant changes:** NO
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:** None
-   **Known regressions:** O deploy em produção está servindo uma versão antiga do frontend.

**Credentials to test flow:**
-   **Admin:**  / 

**What agent forgot to execute**
-   O agente identificou que o arquivo  era desnecessário e afirmou que o removeria, mas não executou o comando  para de fato deletar o arquivo antes de finalizar a interação.</analysis>
