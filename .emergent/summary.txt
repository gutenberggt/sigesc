<analysis>**original_problem_statement:**
O usuário iniciou a tarefa com o objetivo de criar a funcionalidade de geração da Ficha Individual do Aluno em PDF. O escopo foi expandido para incluir múltiplos ajustes de layout em todos os PDFs, a criação de uma página de gerenciamento para a Unidade Mantenedora, a centralização dos dados da mantenedora em todo o sistema (cabeçalho, PDFs, formulários), e a correção de um bug no formulário de escolas.

Subsequentemente, o usuário solicitou e o agente implementou as seguintes funcionalidades e correções:
-   Alterar o download de PDFs para que abram em uma nova aba do navegador.
-   Adicionar campos calculados de Idade e Série Ideal no formulário de alunos, com lógica de data de corte.
-   Importar em massa uma lista de 224 servidores a partir de uma planilha Excel.
-   Adicionar novos cargos à lista de servidores e ordená-la alfabeticamente.
-   Alterar a exclusão de usuários de soft delete para hard delete.
-   Adicionar um contador de registros dinâmico e filtrável à página de gestão de servidores.
-   Permitir que um servidor tenha múltiplas funções (lotações) na mesma escola.
-   Corrigir a contagem de usuários na página de gerenciamento, que estava limitada a 100.
-   Adicionar o campo CPF ao cadastro e visualização de servidores.
-   Criar 16 novas turmas e matricular 240 alunos aleatoriamente com base na idade ideal.
-   Implementar uma lógica de filtragem complexa para componentes curriculares na alocação de professores, baseada no nível da turma e se a escola oferece Escola Integral.
-   O último pedido do usuário foi investigar por que os alunos recém-matriculados não estão aparecendo na página de Frequência.

**User's preferred language**: Portuguese (Português)

**what currently exists?**
Um sistema de gestão escolar (SIGESC) full-stack (React/FastAPI/MongoDB) com funcionalidades robustas de gerenciamento de alunos, servidores, escolas e turmas. Os dados da Unidade Mantenedora estão centralizados e são usados para a identidade visual da aplicação e nos documentos PDF. A geração de documentos (Boletim, Ficha, Declarações) agora abre o PDF diretamente no navegador. O sistema permite a gestão complexa de servidores, incluindo múltiplas lotações na mesma escola e uma lógica de alocação de professores a componentes curriculares baseada em regras específicas. A importação de dados em massa via scripts foi utilizada com sucesso.

**Last working item**:
-   **Last item agent was working:** O agente estava começando a investigar por que a página de Lista de Frequência não exibe os alunos que foram matriculados em uma turma. O usuário relatou o problema e forneceu um screenshot de uma lista de frequência vazia.
-   **Status:** IN PROGRESS
-   **Agent Testing Done:** N
-   **Which testing method agent to use?** both. O agente de backend para verificar o endpoint  e o agente de frontend para simular os passos do usuário (navegar para Frequência, selecionar escola e turma) e analisar os logs do console e as requisições de rede.
-   **User Testing Done:** N (User reported the issue, which counts as a failed test).

**All Pending/In progress Issue list**:
-   **Issue 1: (P0) Alunos não aparecem na lista de frequência.**
-   **Issue 2: (P1) A funcionalidade de Gerenciar Lotações pode não estar salvando corretamente.**
-   **Issue 3: (P2) Dados órfãos de lotação de servidores.**

Issues Detail:
-   **Issue 1: Alunos não aparecem na lista de frequência.**
    -   **Attempted fixes:** Nenhuma tentativa ainda. O agente estava prestes a iniciar a investigação.
    -   **Next debug checklist:**
        1.  Verificar o código do frontend em  para entender como a chamada de API é feita.
        2.  Analisar a chamada de rede no navegador para o endpoint  quando uma turma é selecionada. Verificar o status da resposta e os dados retornados.
        3.  Inspecionar a lógica do endpoint no backend em  para garantir que a consulta ao banco de dados para buscar alunos matriculados () e seus dados () está correta.
        4.  Confirmar no banco de dados que as matrículas para a turma selecionada existem e estão com o status correto.
    -   **Why fix this issue and what will be achieved with the fix?** A lista de frequência é uma funcionalidade central para professores e administração. A correção permitirá o registro e acompanhamento da presença dos alunos.
    -   **Status:** IN PROGRESS
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** both
    -   **Blocked on other issue:** N/A

-   **Issue 2: A funcionalidade de Gerenciar Lotações pode não estar salvando corretamente.**
    -   **Attempted fixes:** O agente investigou a API e o fluxo do frontend, concluindo que a funcionalidade estava funcionando (conseguiu salvar novas lotações em testes com screenshots). No entanto, a falha pode ser específica para o cenário do usuário.
    -   **Next debug checklist:** Aguardar um feedback mais detalhado do usuário com os passos exatos que estão resultando na falha. Se o usuário confirmar o problema, registrar o fluxo com o agente de testes de frontend para reproduzir o erro.
    -   **Why fix this issue and what will be achieved with the fix?** Garante que os administradores possam gerenciar corretamente as atribuições de servidores às escolas.
    -   **Status:** USER VERIFICATION PENDING
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** frontend
    -   **Blocked on other issue:** N/A

-   **Issue 3: Dados órfãos de lotação de servidores.**
    -   **Attempted fixes:** None. This is a known issue from a previous job.
    -   **Next debug checklist:**
        1.  Escrever um script para iterar sobre todas as .
        2.  Para cada lotação, verificar se a  associada ainda existe na coleção .
        3.  Gerar um relatório de lotações órfãs e propor um plano de limpeza (ex: excluir as lotações ou movê-las para um estado arquivado).
    -   **Why fix this issue and what will be achieved with the fix?** Melhorará a integridade dos dados e evitará erros em relatórios ou visualizações que dependem de lotações válidas.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** backend
    -   **Blocked on other issue:** N/A

**In progress Task List**:
-   **Task 1: Validar a lógica de filtragem de Componentes Curriculares (P1)**
    -   **Where to resume:** A implementação foi concluída e um bug de runtime () foi corrigido. O próximo passo é uma validação funcional completa. O agente de testes de frontend deve ser usado para simular um cenário:
        1. Selecionar um professor e abrir o modal de alocação.
        2. Selecionar uma escola que **não** tem Escola Integral.
        3. Adicionar uma turma (ex: 5º Ano).
        4. Verificar se a lista de componentes contém apenas os do 5º Ano (ex: Matemática, Português) e **NÃO** contém os componentes de Escola Integral.
        5. Repetir para uma escola que **tem** Escola Integral e verificar se os componentes integrais aparecem.
    -   **What will be achieved with this?** Garante que os professores só possam ser alocados aos componentes curriculares corretos, evitando erros de atribuição.
    -   **Status:** TESTING PENDING
    -   **Should Test frontend/backend/both after fix?** frontend
    -   **Blocked on something:** N/A

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   **(P1)** Implementar a lógica de geração do PDF do Certificado do aluno. O endpoint () e a função  em  são atualmente placeholders.
-   **Future Tasks:**
    -   **(P2)** Refatorar : O arquivo é grande e complexo.
    -   **(P3)** Refatorar : Precisa ser dividido para melhor manutenibilidade.
    -   **(P4)** Refatorar : Crescendo em complexidade.
    -   **(P4)** Refatorar : O hook está se tornando muito grande e gerenciando muitos estados, devendo ser dividido em hooks menores e mais focados.

**Completed work in this session**
-   **PDFs Abertos no Navegador:** Alterado o  de  para  em todos os endpoints de geração de PDF.
-   **Melhoria no Formulário de Aluno:** Adicionados os campos somente leitura Idade e Série Ideal, que são calculados dinamicamente com base na data de nascimento e na data de corte de 31 de março.
-   **Gestão de Servidores Aprimorada:**
    -   Adicionado o campo CPF ao formulário e à tela de detalhes.
    -   Importados 224 servidores de uma planilha Excel.
    -   Adicionados novos cargos (Mediador, etc.) e a lista foi ordenada alfabeticamente.
    -   Permitida a lotação de um servidor com múltiplas funções na mesma escola.
    -   Adicionado um contador de registros filtrável à página principal.
-   **Gestão de Usuários Corrigida:**
    -   A exclusão de usuários agora é permanente (hard delete).
    -   Corrigido o contador de total de usuários, que estava limitado a 100 pelo backend.
-   **Criação de Turmas em Massa:** Criadas 16 turmas em 3 escolas diferentes e matriculados 240 alunos, respeitando a idade ideal para cada série.
-   **Filtragem de Componentes Curriculares:** Implementada (e corrigida) uma lógica complexa no modal de alocação de professores para exibir apenas os componentes relevantes para a turma selecionada e as configurações da escola.
-   **Atualizações de Terminologia:** Substituído Componentes Integradores por Escola Integral em vários locais da aplicação.

**Earlier issues found/mentioned but not fixed**
-   **Issue 1: Dados órfãos de lotação de servidores:** Lotações de servidores podem estar vinculadas a IDs de escolas que não existem mais. Status: NOT STARTED.
-   **Issue 2: Refatoração de componentes grandes:** , , e  foram mencionados como necessitando de refatoração. Status: NOT STARTED.

**Known issue recurrence from previous fork**
-   None.

**Code Architecture**


**Key Technical Concepts**
-   **Dynamic Frontend Calculation:** Uso de  e  em React para calcular e exibir dados derivados (idade, série ideal) em tempo real.
-   **Complex Frontend Filtering Logic:** Implementação de um  hook () que depende de múltiplos estados para filtrar dinamicamente uma lista de opções para um dropdown.
-   **Hard vs. Soft Delete:** Alteração de um endpoint FastAPI de atualizar um campo  para usar  para remoção permanente.
-   **Backend API Limits:** Correção de um bug de contagem removendo um limite hardcoded () em uma consulta de banco de dados no backend.
-   **Scripting for Data Migration:** Uso de scripts Python para analisar arquivos Excel e fazer chamadas de API em lote para criar/atualizar centenas de registros.

**key DB schema**
-   **users:** O comportamento de exclusão mudou de soft para hard delete.
-   **staff:** O campo  () foi atualizado para incluir 'auxiliar_secretaria', 'mediador', 'auxiliar_servicos_gerais'. O campo  está sendo salvo.
-   **school_assignments:** A lógica de validação no backend foi alterada para permitir a existência de um par  múltiplas vezes, desde que o campo  seja diferente.
-   **enrollments:** Coleção que vincula  a . É a fonte de dados para a lista de frequência.

**changes in tech stack**
-   None.

**All files of reference**
-   **/app/frontend/src/pages/Attendance.js**: Local do bug atual.
-   **/app/backend/server.py**: Contém os endpoints de API relevantes, incluindo o de frequência.
-   **/app/frontend/src/hooks/useStaff.js**: Contém a lógica de alocação de professores que foi recentemente modificada e pode ter efeitos colaterais.
-   **/app/frontend/src/pages/StudentsComplete.js**: Contém a lógica de cálculo da idade/série ideal.
-   **/app/frontend/src/components/staff/AlocacaoModal.js**: Componente com a nova e complexa lógica de filtragem que precisa de validação.

**Areas that need refactoring**:
-   
-   
-   
-    (está se tornando um god hook e deve ser dividido).

**key api endpoints**
-   ****: **(SUSPEITO)** Endpoint que busca os alunos de uma turma para a lista de frequência. Provável fonte do bug atual.
-   ****: **(MODIFICADO)** Agora realiza uma exclusão permanente.
-   ****: **(MODIFICADO)** Removeu o limite de 100 e agora retorna todos os usuários.
-   ****: **(MODIFICADO)** Lógica de validação alterada para permitir múltiplas funções para um servidor na mesma escola.
-   ****: **(MODIFICADO)** Todos os 4 endpoints de documentos agora usam .

**Critical Info for New Agent**
-   **Current Blocker:** A principal prioridade é corrigir a página de Lista de Frequência, que não está exibindo os alunos matriculados. A investigação deve começar no endpoint  e no seu consumo pelo frontend em .
-   **Complex Staff Logic:** A lógica de alocação de professores () agora possui um filtro complexo para componentes curriculares. Uma validação funcional completa desta feature é necessária para garantir que não há regressões.
-   **User-Reported Issues:** O usuário relatou que as Lotações não estavam salvando. Embora o agente não tenha conseguido reproduzir o erro, fique atento a essa possibilidade e peça um passo a passo detalhado ao usuário se o problema for mencionado novamente.

**documents and test_reports created in this job**
-   None.

**Last 10 User Messages and any pending HUMAN messages**
1.  
2.  
3.  
4.  
5.  
6.  
7.  
8.  
9.  
10. 

**Project Health Check:**
-   **Broken:** A funcionalidade de Lista de Frequência está quebrada.
-   **Mocked:** None

**3rd Party Integrations**
-   **reportlab**: Utilizado no backend para a geração de documentos PDF.
-   **Servidor FTP Externo ()**: Utilizado para o armazenamento persistente de arquivos como logotipos e fotos de perfil.

**Testing status**
-   **Testing agent used after significant changes:** NO (O agente usou  e  extensivamente, mas não o agente de testes para as funcionalidades mais recentes).
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:** None
-   **Known regressions:** A lista de frequência não funciona após a matrícula de novos alunos.

**Credentials to test flow:**
-   **Admin:**  / 
-   **Professor:**  / 

**What agent forgot to execute**
-   O agente não realizou uma validação funcional completa da complexa lógica de filtragem de componentes curriculares após corrigir o erro de runtime . O bug foi corrigido, mas o comportamento correto da feature não foi confirmado.
-   O agente concluiu que o problema de salvar lotações estava resolvido do seu lado, mas não obteve uma confirmação final do usuário, deixando a questão em aberto.</analysis>
