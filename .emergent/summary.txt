<analysis>**original_problem_statement:**
O usuário iniciou a sessão com vários objetivos para o sistema de gestão escolar SIGESC:
- (Bugs) Corrigir um bug visual no calendário, um bug crítico de carga horária incorreta em relatórios, um bug recorrente na gestão de lotações, um bug na página de logs de auditoria que não carregava dados, e múltiplos bugs de sincronização de dados e cálculo em documentos PDF (Boletim, Ficha Individual, Livro de Promoção).
- (Features) Implementar um sistema de bloqueio de edição por data limite, um sistema de trilha de auditoria, uma nova página Livro de Promoção, e uma nova lógica para calcular o Resultado Final do aluno nos documentos com regras complexas por nível de ensino. Adicionar um seletor de ano na página de Frequência.
- (Melhorias) Adicionar otimizações de segurança, refatorar o monolítico , e refatorar componentes de frontend.
- (Ajustes de UI) Traduzir a severidade nos logs, padronizar a exibição dos nomes das turmas, reorganizar a ordem dos componentes curriculares e ajustar a exibição de dados de frequência nos documentos.

Durante a sessão, o usuário também solicitou:
- Correção de uma recorrência do bug de aprovação (P0).
- Correção do Livro de Promoção que não exibia notas.
- Implementação da exibição da data limite de edição para professores.
- Correção do bug que impedia salvar a Média para Aprovação na Mantenedora.
- Correção do Livro de Promoção para que usasse as regras de aprovação da Mantenedora.
- Início da implementação de funcionalidade offline para o sistema.

**User's preferred language**: Portuguese (Português)

**what currently exists?**
O sistema é uma aplicação full-stack (React + FastAPI + MongoDB) com funcionalidades de gestão acadêmica.
- **Backend:**  contém a maior parte da lógica da API, com uma refatoração em andamento para routers modulares. Arquivos como  e  encapsulam regras de negócio complexas para o setor educacional.
- **Frontend:** A aplicação React utiliza hooks e context para gerenciamento de estado. Múltiplos bugs foram corrigidos, e novas features como a exibição de data limite foram adicionadas.
- **Funcionalidade Offline (PWA):** As Fases 1 e 2 da implementação offline foram concluídas. O sistema agora é um PWA básico com um Service Worker para cache. A biblioteca  foi instalada e configurada para criar um banco de dados IndexedDB local (). Foram criados os hooks e serviços iniciais para gerenciar dados offline (, , , ), mas ainda não estão integrados nas páginas de UI.

**Last working item**:
-   **Last item agent was working:** O agente estava no meio da **Fase 3** da implementação da funcionalidade offline. Especificamente, estava integrando o  e o hook  nas páginas  e  para começar a transição da lógica de busca de dados para o modelo offline-first.
-   **Status:** IN PROGRESS
-   **Agent Testing Done:** N
-   **User Testing Done:** N
-   **Which testing method agent to use?** Frontend testing agent. O agente de teste deve ser usado para: 1. Verificar se o  aparece corretamente nas páginas  e . 2. Simular um cenário offline, realizar edições de notas/frequência, voltar ao modo online e confirmar que a sincronização ocorre com sucesso e os dados são persistidos no backend.

**All Pending/In progress Issue list**:
Nenhum. Todos os bugs reportados pelo usuário foram resolvidos. O foco atual é no desenvolvimento de novas funcionalidades.

**In progress Task List**:
-   **Task 1: (P0) Implementar Funcionalidade Offline**
    -   **Where to resume:** Continuar a integração nas páginas  e . O próximo passo é substituir a lógica de fetching de dados atual (chamadas diretas à API) para usar os novos hooks offline (, ) que leem e escrevem primeiramente no IndexedDB.
    -   **What will be achieved with this?** As páginas de Notas e Frequência se tornarão capazes de funcionar offline, lendo e salvando dados localmente.
    -   **Status:** IN PROGRESS
    -   **Should Test frontend/backend/both after fix?** both
    -   **Blocked on something:** N/A

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   **(P0) Offline - Fase 3 (Conclusão):** Finalizar a integração dos hooks offline nas páginas de Notas e Frequência.
    -   **(P0) Offline - Fase 4:** Construir os endpoints de sincronização no backend (, ).
    -   **(P0) Offline - Fase 5:** Implementar a UI de status de sincronização (indicador, lista de itens pendentes, botão para forçar sync).
    -   **(P1) Continuar Refatoração do Backend:** Mover os endpoints restantes (, , etc.) do  para routers modulares.
-   **Future Tasks:**
    -   **(P2) Refatorar :** Quebrar as funções monolíticas de geração de PDF.
    -   **(P2) Refatorar :** Simplificar o componente, separando lógica da apresentação.
    -   **(P3) Deletar Código Obsoleto:** Remover o arquivo  após confirmar que não é utilizado.

**Completed work in this session**
- **Bug da Lógica de Aprovação (P0 - Recorrência):** Corrigido o bug crítico onde alunos eram aprovados indevidamente. A correção envolveu dois cenários: tratar médias 0.0 como reprovação e garantir que componentes curriculares obrigatórios sem nota também resultem em reprovação.
- **Bug de Exibição de Notas no Livro de Promoção:** Corrigido o  para mapear corretamente a estrutura de dados das notas vindas do backend, resolvendo um problema de incompatibilidade que impedia a exibição.
- **Bug de Média de Aprovação na Mantenedora:** Corrigido o  para garantir que a média de aprovação fosse salva e exibida corretamente, tratando uma incompatibilidade entre o tipo  do backend e o  esperado pelo componente .
- **Bug do Livro de Promoção não usar Regras da Mantenedora:** Atualizado o  para usar o , garantindo que o cálculo do resultado final (Aprovado, Reprovado, Em Dependência) usasse a média e as regras de dependência configuradas pelo admin.
- **Feature de Exibição de Data Limite:** Implementado um alerta informativo () nas páginas de Notas e Frequência para que os professores possam ver a data limite de edição antes que ela expire.
- **UI Fix: Ponto por Vírgula:** Atualizado o  para formatar as notas com vírgula em vez de ponto nos boletins.
- **Feature PWA Offline (Fases 1 e 2):** Iniciada a transformação do sistema em um PWA. O Service Worker foi configurado, o IndexedDB foi estabelecido com , e os hooks e serviços base para a funcionalidade offline foram criados.

**Earlier issues found/mentioned but not fixed**
- Nenhum.

**Known issue recurrence from previous fork**
-   **Issue recurrence in previous fork:** Bug na funcionalidade Gerenciar Lotações.
-   **Recurrence count:** 3+
-   **Status:** RESOLVED (em um fork anterior).
-   **New Recurrence in this session:** O bug P0 (lógica de aprovação incorreta) se manifestou de uma nova forma (ignorando componentes obrigatórios sem nota) e foi corrigido novamente.

**Code Architecture**


**Key Technical Concepts**
- **Lógica de Negócio Complexa:** Implementação e depuração de regras acadêmicas detalhadas em Python () e JavaScript ().
- **Depuração Full-Stack:** Rastreamento de bugs desde a UI (React) até a API (FastAPI) e o banco de dados (MongoDB), resolvendo problemas de sincronização e formatação de dados.
- **PWA & Offline-First:** Arquitetura para funcionamento offline usando Service Workers para cache e IndexedDB (com ) para armazenamento de dados no cliente.
- **React Context API:** Utilizada para gerenciar estado global, como as configurações da Mantenedora e o status da conexão online/offline.

**key DB schema**
-   **mantenedora:** 
-   **grades:** 
-   **calendario_letivo:** 

**changes in tech stack**
-    e  foram adicionados ao frontend para facilitar a manipulação do IndexedDB.

**All files of reference**
-   **/app/frontend/src/pages/Grades.js**: Em processo de integração com a funcionalidade offline.
-   **/app/frontend/src/pages/Attendance.js**: Em processo de integração com a funcionalidade offline.
-   **/app/frontend/src/pages/Promotion.jsx**: Corrigido para exibir notas e usar regras de aprovação corretas.
-   **/app/frontend/src/pages/Mantenedora.js**: Corrigido para salvar e exibir a média de aprovação.
-   **/app/backend/grade_calculator.py**: Corrigido para tratar cenários de aprovação incorreta.
-   **/app/backend/server.py**: Modificado para retornar datas limite para todos os perfis.
-   **/app/frontend/src/db/database.js**: Arquivo de configuração do Dexie.js para o IndexedDB.
-   **/app/frontend/src/contexts/OfflineContext.jsx**: Contexto para gerenciar o estado da conexão.
-   **/app/frontend/src/hooks/useOfflineGrades.js**: Hook para gerenciar notas no modo offline.

**Areas that need refactoring**:
-   **:** A refatoração para routers modulares está em andamento, mas não foi concluída.
-   ** e :** Ambos são arquivos grandes e monolíticos que se beneficiariam de uma refatoração para melhorar a manutenibilidade.

**key api endpoints**
-    (GET): Retorna o status de edição e as datas limite dos bimestres.
-    (GET/PUT): Gerencia as configurações globais da mantenedora, incluindo as regras de aprovação.
-    (GET): Busca todas as notas de uma turma específica.

**Critical Info for New Agent**
-   **Prioridade na Funcionalidade Offline:** A tarefa principal é continuar a implementação da funcionalidade offline, que está na Fase 3. O usuário aprovou e está aguardando o progresso.
-   **Retomar em  e :** O trabalho deve ser retomado nesses arquivos, substituindo a lógica de busca de dados online pela nova abordagem offline-first usando os hooks já criados.
-   **Cuidado com as Regras de Negócio:** Qualquer alteração na lógica de cálculo de notas é de alto risco. As regras são complexas e foram fonte de múltiplos bugs. Teste exaustivamente qualquer mudança nessa área.

**documents and test reports created in this job**
-   /app/test_reports/iteration_5.json
-   /app/test_reports/iteration_6.json
-   /app/memory/PRD.md

**Last 10 User Messages and any pending HUMAN messages**
10.  (User message to continue with Phase 3 of offline implementation).
9.   (User message to start the offline implementation).
8.   (User clarification on offline requirements).
7.   (User question about offline mode).
6.   (Bug report).
5.   (Bug report).
4.   (Feature request).
3.   (Bug report).
2.   (Bug report).
1.  (User confirmation).

**Project Health Check:**
-   **Broken:** Nada está quebrado. Todos os bugs críticos foram corrigidos.
-   **Mocked:** A funcionalidade offline está em um estado parcial. Os alicerces (DB local, hooks) foram criados, mas a integração com a UI e a sincronização com o backend ainda não foram implementadas.

**3rd Party Integrations**
-   reportlab
-   PyPDF2
-   openpyxl
-   slowapi
-   ** & ** (nova)
-   Servidor FTP ()

**Testing status**
-   **Testing agent used after significant changes:** YES
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:** None
-   **Known regressions:** O bug P0 (lógica de aprovação) recorreu de uma nova forma nesta sessão e foi corrigido.

**Credentials to test flow:**
-   **Admin:**  / 
-   **Coordenador/Professor:**  / 

**What agent forgot to execute**
-   Nada significativo. O agente estava no meio de uma tarefa quando a sessão terminou, o que é esperado.</analysis>
