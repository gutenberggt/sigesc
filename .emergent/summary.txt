<analysis>**original_problem_statement:**
O usuário iniciou a sessão para resolver um problema crítico de deploy no ambiente de produção (Coolify), onde as alterações de frontend e backend não estavam sendo refletidas. A investigação revelou múltiplos problemas subjacentes, incluindo cache de imagem Docker, erros de configuração do Nginx, e uma configuração de rede/proxy (Traefik) incorreta.

Após resolver o problema de deploy, a sessão evoluiu para uma série de solicitações de funcionalidades e correções, com foco principal no refinamento das permissões do perfil Secretário:
-   Corrigir título duplicado na barra de título do PWA.
-   Garantir que secretários possam visualizar todas as escolas, mas editar apenas aquelas a que estão vinculados.
-   Garantir que secretários possam visualizar todos os alunos, mas com permissões de edição e geração de documentos condicionais com base na escola do aluno e no seu status (ativo/inativo).
-   Filtrar a lista de turmas e as estatísticas do dashboard para que o secretário veja apenas dados de suas escolas.
-   Remover a coluna Município da lista de escolas.
-   Investigar e fornecer scripts para uma migração de dados em massa de alunos, o que revelou inconsistências nos dados de status dos alunos.

**User's preferred language**: Portuguese (Português)

**what currently exists?**
A aplicação full-stack (React + FastAPI + MongoDB) está totalmente funcional no ambiente de produção do usuário (Coolify/DigitalOcean). O problema crítico de deploy e cache foi resolvido através de uma investigação profunda e uma série de correções no servidor, incluindo a criação de um arquivo de configuração manual para o proxy Traefik para garantir o roteamento correto para o backend. O sistema de permissões para o perfil Secretário foi extensivamente refatorado tanto no frontend quanto no backend para atender a regras de negócio complexas e granulares.

**Last working item**:
-   **Last item agent was working:** Implementando a regra de negócio final para as permissões do secretário: exibir os botões para gerar documentos de um aluno apenas se o secretário estiver vinculado à escola daquele aluno.
-   **Status:** IN PROGRESS
-   **Agent Testing Done:** N
-   **Which testing method agent to use?** Frontend testing agent. O agente deve fazer login como um usuário secretário e navegar para a página de gerenciamento de alunos (). O teste deve verificar se a lista contém alunos de todas as escolas e se o botão Documentos aparece apenas nas linhas correspondentes a alunos das escolas vinculadas ao secretário.
-   **User Testing Done:** N

**All Pending/In progress Issue list**:
-   **Issue 1: (P0) Configuração Manual e Frágil do Traefik**
    -   **Description:** O roteamento do tráfego para o backend na produção depende de um arquivo de configuração manual () criado dentro do container do proxy Traefik. Esta solução foi necessária para resolver um problema de comunicação de rede do Docker, mas é frágil. Se o Coolify recriar o container do proxy ou se o nome de serviço do backend mudar, a API ficará inacessível.
    -   **Attempted fixes:** Conectar os containers à mesma rede Docker e reiniciar o Traefik não resolveu o problema, forçando a solução manual.
    -   **Next debug checklist:**
        1.  Investigar a configuração do provedor Docker do Traefik no Coolify. Verificar se há  ou outros filtros que impedem o Traefik de descobrir automaticamente os containers em outras redes.
        2.  Explorar a documentação do Coolify para entender a maneira correta de expor um serviço em uma rede para que o Traefik (proxy global) o detecte.
        3.  Tentar adicionar o backend e o frontend à rede  diretamente através do  do projeto, se o Coolify permitir.
    -   **Why fix this issue and what will be achieved with the fix?** Eliminará um ponto único de falha crítico na infraestrutura de produção, tornando os deploys mais robustos e alinhados com o gerenciamento automatizado do Coolify.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** N (Foi a solução para um problema recorrente).
    -   **Should Test frontend/backend/both after fix?** Backend (verificando a acessibilidade da API via domínio público).
    -   **Blocked on other issue:** Não.

-   **Issue 2: (P1) Inconsistência nos Dados de Status dos Alunos**
    -   **Description:** A base de dados de produção contém valores diferentes para o status de um aluno, como  (Português, maiúscula) e  (Inglês, minúscula). Um patch foi aplicado no frontend () para exibir ambos corretamente, mas a inconsistência nos dados persiste.
    -   **Attempted fixes:** O agente forneceu scripts para atualização em massa, mas o usuário relatou problemas. A correção no frontend foi uma mitigação.
    -   **Next debug checklist:**
        1.  Criar e fornecer ao usuário um script MongoDB final e validado para padronizar todos os valores de status na coleção  para um único formato (ex: ).
        2.  Verificar no backend se alguma lógica de criação/atualização de aluno ainda pode gerar o valor incorreto.
    -   **Why fix this issue and what will be achieved with the fix?** Garantirá a consistência dos dados, simplificará a lógica no código (removendo a necessidade de checar múltiplos valores) e evitará bugs futuros em relatórios ou outras funcionalidades que dependam do status do aluno.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** Backend (verificando os dados no DB) e Frontend (verificando a exibição na lista de alunos).
    -   **Blocked on other issue:** Não.

**In progress Task List**:
Nenhuma.

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   **(P1) Melhoria Pré-Matrícula:** Enviar um email de confirmação para o responsável após a pré-matrícula ser enviada com sucesso.
    -   **(P1) Melhoria na Lista de Alunos:** Implementar a lógica na página  para usar o parâmetro de URL  e destacar o aluno recém-criado na lista.
-   **Future Tasks:**
    -   **(P2) Refatoração do Backend:** Continuar movendo endpoints do  para routers modulares.
    -   **(P2) Refatoração do Frontend:** Simplificar o componente , que se tornou muito complexo.
    -   **(P2) Expansão Offline:** Estender a funcionalidade offline para o módulo de matrículas.
    -   **(P2) Padronização de Erros:** Aplicar o utilitário  em todos os componentes restantes que fazem chamadas de API.
    -   **(P3) Limpeza de Código:** Remover o arquivo obsoleto .
    -   **(P3) Relatórios:** Criar relatórios gerenciais para atestados médicos (ex: por período, por escola).

**Completed work in this session**
-   **Resolução de Falha Crítica de Deploy:** Diagnosticado e resolvido um problema complexo de deploy em produção que envolvia cache de build do Docker, configuração do Nginx e, crucialmente, roteamento de rede do Traefik.
-   **Refatoração de Permissões (Secretário):** Implementadas regras de negócio detalhadas para o perfil secretário, incluindo:
    -   Visualização de todos os alunos, mas com edição restrita àqueles de sua escola ou com status inativo.
    -   Botão de Gerar Documentos condicional ao vínculo com a escola do aluno.
    -   Listagem de turmas na página de turmas filtrada por escola.
    -   Contagem de estatísticas no dashboard filtrada por escola.
-   **Correção de Inconsistência de Dados (Backend):** O backend () foi corrigido para reconhecer o campo  além de , resolvendo o problema das legendas ausentes nos PDFs.
-   **Correções de UI:**
    -   Removida a coluna Município da tabela de escolas ().
    -   Corrigido o título duplicado da aplicação quando instalada como PWA, ajustando o .
-   **Data Migration:** Fornecidos scripts para executar no MongoDB para atualizações em massa de status de alunos.
-   **Infraestrutura:** Identificado e resolvido um conflito com um container  antigo. Criado um arquivo de configuração manual para o Traefik para restaurar a funcionalidade da API.

**Earlier issues found/mentioned but not fixed**
- Nenhum.

**Known issue recurrence from previous fork**
-   O problema de falha de build do frontend evoluiu para o problema de deploy em produção, que foi o foco principal e foi resolvido nesta sessão (embora com uma solução frágil - ver  em ).

**Code Architecture**


**Key Technical Concepts**
-   **Traefik Proxy Debugging:** Diagnóstico avançado de problemas de roteamento no Traefik, incluindo erros de parsing de regras (), problemas de rede entre containers Docker e criação de arquivos de configuração dinâmica manual.
-   **Docker Networking:** Análise e solução de problemas de comunicação entre containers em diferentes redes Docker ().
-   **Docker Build & Cache:** Utilização de  para forçar a limpeza completa do cache de build e garantir a utilização de código atualizado.
-   **Nginx Configuration:** Correção de erros de sintaxe em regex de  que eram incompatíveis com a substituição de variáveis do ambiente de deploy (Coolify).
-   **Conditional UI Rendering (React):** Implementação de lógica complexa para renderizar/habilitar botões e exibir dados com base no papel do usuário (), no vínculo com a escola e no status de um item específico (aluno).
-   **React Hooks Optimization:** Uso de  para evitar re-renderizações infinitas em  quando uma dependência é um array ou objeto recriado a cada render.

**key DB schema**
-   **students:** O campo  demonstrou ter valores inconsistentes (Transferido e transferred).
-   **classes:** O campo  existe na produção, enquanto o código esperava .
-   **users:** O campo  não estava sendo populado corretamente durante o login para usuários cujo vínculo escolar vinha de .

**changes in tech stack**
-   Nenhuma mudança de tecnologia, mas uma forte dependência de configuração manual foi introduzida na infraestrutura de produção (arquivo de configuração do Traefik).

**All files of reference**
-    (Permissões de  e )
-    (Permissões de )
-    (Permissões de )
-    (Correção do nome do campo )
-    (Lógica principal de permissões condicionais para secretários)
-    (Filtro de turmas para secretário)
-    (Filtro de estatísticas para secretário)
-    (Remoção da coluna Município)
-    (Refatorado para aceitar função  por linha)
-    (Correção do título do PWA)
-    (Arquivo CRÍTICO, criado manualmente no servidor de produção)

**Areas that need refactoring**:
-   **Infraestrutura de Deploy:** A solução manual do Traefik precisa ser substituída por uma configuração automática gerenciada pelo Coolify para garantir a robustez (ver ).
-   : Este componente continua a crescer em complexidade com a adição de mais lógicas de permissão. Ele é um forte candidato a ser quebrado em subcomponentes e hooks personalizados.

**key api endpoints**
-   : Usado extensivamente para depurar a conectividade do backend.
-   : Ponto central da investigação sobre por que os  do secretário não estavam sendo populados.
-   : Endpoint modificado para retornar todos os alunos para o secretário.
-   : Endpoint modificado para retornar todas as turmas para o secretário.
-   : A inacessibilidade deste endpoint (404) foi um indicador chave de que o backend em produção estava desatualizado.

**Critical Info for New Agent**
-   **A MAIOR PRIORIDADE É TORNAR O DEPLOY ROBUSTO.** A configuração atual do backend em produção depende de um arquivo () que foi criado manualmente no servidor. Você deve trabalhar para substituir essa solução manual por uma configuração automática gerenciada pelo Coolify para evitar falhas em futuros deploys. Consulte o  para um plano de ação.
-   A base de dados de produção tem inconsistências no campo  dos alunos. Foi feito um patch no frontend, mas a fonte do problema (os dados) deve ser corrigida.
-   As permissões para o papel Secretário são complexas e distribuídas entre o frontend (renderização condicional) e o backend (validação da API). Qualquer alteração nessa área requer testes cuidadosos em ambos os lados.

**documents and test reports created in this job**
-    (Atualizado com o trabalho concluído).

**Last 10 User Messages and any pending HUMAN messages**
10. **Usuário:** Na lista de alunos, para o secretário, mostrar a escola e a turma.
9.  **Usuário:** O secretário deve ter o card de estatísticas de turmas no dashboard filtrado para suas escolas.
8.  **Usuário:** Na página de turmas, o secretário deve ver apenas as turmas de suas escolas.
7.  **Usuário:** Remover a coluna Município da lista de escolas.
6.  **Usuário:** O secretário deve poder editar alunos de qualquer escola, desde que o status não seja Ativo.
5.  **Usuário:** O secretário deve ver TODOS os alunos, mas o botão de edição só deve aparecer para alunos ativos de sua escola.
4.  **Usuário:** O status dos alunos está incorreto na UI. A mudança para Transferido não reflete.
3.  **Usuário:** O script para mudar o status de todos os alunos para Transferido não funcionou, eles ainda aparecem como Ativo.
2.  **Usuário:** O secretário deve ter acesso de edição aos dados da(s) escola(s) onde possui vínculo.
1.  **Usuário:** O título do PWA está aparecendo duplicado.

**Project Health Check:**
-   **Broken:** Nada está funcionalmente quebrado para o usuário final no momento.
-   **Fragile:** O roteamento da API em produção é extremamente frágil devido à configuração manual do Traefik, representando um risco significativo para futuros deploys.

**3rd Party Integrations**
-   reportlab
-   PyPDF2
-   openpyxl
-   slowapi
-   dexie & dexie-react-hooks
-   uuid

**Testing status**
-   **Testing agent used after significant changes:** NO
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:** None
-   **Known regressions:** Nenhuma regressão funcional. A única regressão é na manutenibilidade da infraestrutura.

**Credentials to test flow:**
-   **Admin:**  / 
-   **Secretário:**  (a senha não foi fornecida, mas é o usuário de teste para as permissões de secretário).

**What agent forgot to execute**
-   O agente não esqueceu nenhuma tarefa explícita. No entanto, a solução para o problema de deploy (a configuração manual do Traefik) introduziu uma fragilidade técnica significativa que agora se tornou a principal dívida técnica a ser resolvida.</analysis>
